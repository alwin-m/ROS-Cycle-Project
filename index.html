<!--
MIT License
Copyright (c) 2025 Alwin
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#FF6B9D" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="#FF6B9D" />
  <meta name="description" content="Gentle period companion for tracking your cycle" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="./icon-192.png" />
  <link rel="icon" type="image/png" href="alwin.png" />
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" as="style" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet" async />
  <title>ROS Cycle ‚Äî gentle period companion</title>
  <style>
    :root{
      --bg1:#FFF0F5;--bg2:#F0FFF0;--pink:#FF6B9D;--soft:#FFB6C1;--mint:#98D8C8;
      --purple:#D8BFD8;--deep-purple:#BA55D3;--text:#3b3b3b;--muted:#8A8A8A;--card:#ffffff;
      --shadow:0 6px 24px rgba(0,0,0,0.08);--bg-dark:#2b2b2b;--card-dark:#3c3c3c;--text-dark:#f0f0f0;--muted-dark:#b0b0b0;
    }
    [data-theme="dark"]{--bg1:#2b2b2b;--bg2:#3c3c3c;--card:#3c3c3c;--text:#f0f0f0;--muted:#b0b0b0;}
    *{box-sizing:border-box;}html,body{height:100%;}
    body{font-family:'Nunito',system-ui,-apple-system,Segoe UI,Roboto;margin:0;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);padding:20px;overscroll-behavior:none;}
    .app{width:100%;max-width:760px;background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:20px;}
    header{display:flex;align-items:center;gap:16px;}
    .logo{font-size:28px;font-weight:800;background:linear-gradient(45deg,var(--pink),var(--soft));-webkit-background-clip:text;color:transparent;}
    .lead{color:var(--muted);font-weight:300;}
    .step-indicator{margin:10px 0;font-size:13px;color:var(--muted);text-align:center;}
    main{margin-top:14px;}
    .step{display:none;opacity:0;transform:translateY(12px);transition:all .28s ease;}
    .step.active{display:block;opacity:1;transform:translateY(0);}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 4px 18px rgba(0,0,0,0.04);}
    .field{margin-bottom:12px;text-align:left;}
    label{display:block;font-weight:600;margin-bottom:6px;}
    input[type="text"],input[type="date"],input[type="number"]{width:100%;padding:12px 14px;border-radius:10px;border:1.5px solid #f2dce4;
    background:var(--card);outline:none;color:var(--text);font-size:16px;-webkit-appearance:none;}
    input:focus{box-shadow:0 6px 20px rgba(255,107,157,0.12);border-color:var(--pink);}
    .controls{display:flex;gap:10px;justify-content:flex-end;margin-top:10px;}
    button{cursor:pointer;border:0;padding:10px 16px;border-radius:12px;font-weight:700;font-size:16px;touch-action:manipulation;}
    .btn-primary{background:linear-gradient(45deg,var(--pink),var(--soft));color:white;}
    .btn-ghost{background:transparent;color:var(--text);}
    .month-nav{display:flex;align-items:center;justify-content:space-between;margin:18px 0;}
    .month-title{font-weight:800;font-size:18px;}
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;}
    .weekday-label{text-align:center;font-size:12px;font-weight:600;color:var(--muted);padding:8px 0;}
    .cell{background:var(--card);border-radius:10px;padding:10px;min-height:56px;display:flex;align-items:flex-start;justify-content:center;
    flex-direction:column;border:1px solid #f4f4f4;position:relative;touch-action:manipulation;}
    .cell.other{background:#fafafa;color:#bbb;}
    .daynum{font-weight:700;}
    .badge{position:absolute;right:8px;top:8px;font-size:11px;padding:4px 6px;border-radius:8px;}
    .period{background:linear-gradient(45deg,var(--pink),#ff9bbf);color:#fff;}
    .fertile{background:linear-gradient(45deg,var(--mint),#dff6ee);color:var(--text);}
    .high-desire{background:linear-gradient(45deg,var(--purple),var(--deep-purple));color:#fff;}
    .legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px;align-items:center;}
    .legend .box{width:14px;height:14px;border-radius:4px;}
    .tooltip{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--card);border-radius:10px;
    padding:8px 10px;box-shadow:0 6px 20px rgba(0,0,0,0.12);white-space:nowrap;font-size:13px;color:var(--text);display:none;z-index:10;}
    .cell:hover .tooltip,.cell:focus-within .tooltip{display:block;}
    @media (max-width:768px){.tooltip{bottom:auto;top:100%;white-space:normal;max-width:90vw;}.grid{gap:6px;}.cell{min-height:64px;}}
    .modal{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:flex;justify-content:center;
    align-items:center;z-index:60;display:none;}
    .modal.active{display:flex;}
    .modal .box{background:var(--card);padding:18px;border-radius:12px;max-width:480px;box-shadow:0 10px 40px rgba(0,0,0,0.18);width:90%;}
    footer{margin-top:16px;font-size:13px;color:var(--muted);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
    .theme-toggle{font-size:12px;cursor:pointer;color:var(--pink);}
    .checkbox-field{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
    .checkbox-field input[type="checkbox"]{width:18px;height:18px;accent-color:var(--pink);}
    a.github-link,a.portfolio-link{color:var(--pink);text-decoration:none;font-weight:600;}
    a.github-link:hover,a.portfolio-link:hover{text-decoration:underline;}

    /* New: Confidence info icon */
    .info-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      line-height: 16px;
      text-align: center;
      font-size: 11px;
      font-weight: bold;
      background: var(--soft);
      color: white;
      border-radius: 50%;
      margin-left: 6px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s;
    }
    .info-icon:hover,
    .info-icon:focus {
      background: var(--pink);
      transform: scale(1.15);
      box-shadow: 0 0 0 3px rgba(255,107,157,0.2);
    }
    .confidence-text {
      display: flex;
      align-items: center;
      gap: 4px;
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="ROS Cycle period tracker">
    <header>
      <div class="logo">üå∏ ROS Cycle</div>
      <div>
        <div class="lead">Gentle, private & student-friendly</div>
        <div style="font-size:12px;color:var(--muted)">No data stored. Local only for this demo.</div>
      </div>
    </header>
    <main aria-live="polite">
      <!-- Step 1 -->
      <section class="step active" id="step-1">
        <div class="step-indicator">Step 1 of 4</div>
        <div class="card">
          <h3 style="margin:0 0 8px">Hello ‚Äî let's make this simple ‚ú®</h3>
          <p style="margin:0 0 12px;color:var(--muted)">We will ask just a few friendly questions. You can go back anytime.</p>
          <div class="field">
            <label for="name">Name</label>
            <input id="name" type="text" placeholder="How should I call you?" autocomplete="name" />
          </div>
          <div class="field">
            <label for="dob">Date of birth <span style="font-weight:400;color:var(--muted);font-size:13px">(used only for age guidance)</span></label>
            <input id="dob" type="date" />
            <div style="font-size:12px;color:var(--muted);margin-top:6px">If you prefer, you can enter your age instead.</div>
          </div>
          <div class="controls" style="justify-content: space-between;">
            <button class="btn-ghost" onclick="skipInfo()">Skip</button>
            <div>
              <button class="btn-primary" onclick="nextToPCOD()" style="margin-right: 10px;">Check for PCOD</button>
              <button class="btn-primary" onclick="nextToStep2()">Continue</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Step PCOD -->
      <section class="step" id="step-pcod">
        <div class="step-indicator">Step 2 of 4</div>
        <div class="card">
          <h3 style="margin:0 0 8px">Check for Possible PCOD Symptoms</h3>
          <p style="margin:0 0 12px;color:var(--muted)">Answer these questions about common symptoms. This is not a medical diagnosis‚Äîconsult a doctor for advice.</p>
          <form id="pcod-form">
            <div class="checkbox-field"><input type="checkbox" id="symptom1"/><label for="symptom1">Irregular or missed periods</label></div>
            <div class="checkbox-field"><input type="checkbox" id="symptom2"/><label for="symptom2">Excess facial or body hair</label></div>
            <div class="checkbox-field"><input type="checkbox" id="symptom3"/><label for="symptom3">Acne or oily skin</label></div>
            <div class="checkbox-field"><input type="checkbox" id="symptom4"/><label for="symptom4">Difficulty getting pregnant</label></div>
            <div class="checkbox-field"><input type="checkbox" id="symptom5"/><label for="symptom5">Weight gain or difficulty losing weight</label></div>
            <div class="checkbox-field"><input type="checkbox" id="symptom6"/><label for="symptom6">Thinning hair on the scalp</label></div>
            <div class="checkbox-field"><input type="checkbox" id="symptom7"/><label for="symptom7">Darkening of skin (e.g., neck, groin)</label></div>
            <div class="checkbox-field"><input type="checkbox" id="symptom8"/><label for="symptom8">Skin tags</label></div>
            <div class="checkbox-field"><input type="checkbox" id="symptom9"/><label for="symptom9">Pelvic pain</label></div>
            <div class="checkbox-field"><input type="checkbox" id="symptom10"/><label for="symptom10">Fatigue or low energy</label></div>
            <div class="controls">
              <button class="btn-ghost" onclick="showStep(1)">‚Üê Back</button>
              <button class="btn-primary" type="button" onclick="checkPCOD()">Submit</button>
            </div>
          </form>
        </div>
      </section>

      <!-- Step 2: Period details -->
      <section class="step" id="step-2">
        <div class="step-indicator">Step 3 of 4</div>
        <div class="card">
          <h3 style="margin:0 0 8px">Period details</h3>
          <p style="margin:0 0 12px;color:var(--muted)">Just one last step ‚Äî this is used to create friendly estimates.</p>
          <div class="field">
            <label for="last">When did your last period start?</label>
            <input id="last" type="date" />
          </div>
          <div class="field">
            <label for="cycle">Average cycle length (days)</label>
            <input id="cycle" type="number" min="15" max="45" value="28" />
          </div>
          <div class="field">
            <label for="periodLen">Average period length (days)</label>
            <input id="periodLen" type="number" min="3" max="10" value="5" />
          </div>
          <div class="field">
            <label for="variability">Cycle variability (¬± days) <span style="font-weight:400;color:var(--muted);font-size:13px">(optional, for better accuracy)</span></label>
            <input id="variability" type="number" min="0" max="10" value="2" />
          </div>
          <div class="controls">
            <button class="btn-ghost" onclick="showStep('pcod')">‚Üê Back</button>
            <button class="btn-primary" onclick="createCalendar()">Create my calendar</button>
          </div>
        </div>
      </section>

      <!-- Step 3: Calendar -->
      <section class="step" id="step-3">
        <div class="step-indicator">Step 4 of 4</div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
            <div>
              <div id="greeting" style="font-weight:800"></div>
              <div style="font-size:13px;color:var(--muted)" id="age-note"></div>
              <div style="font-size:13px;color:var(--muted)" id="confidence-note"></div>
            </div>
            <div style="text-align:right">
              <div style="font-size:12px;color:var(--muted)">Predicted months: 12</div>
              <div style="font-size:12px;color:var(--muted)">Visible: <span id="visible-month"></span></div>
            </div>
          </div>

          <div class="month-nav">
            <button class="btn-ghost" id="prevBtn">‚Üê</button>
            <div class="month-title" id="monthTitle">Month</div>
            <button class="btn-ghost" id="nextBtn">‚Üí</button>
          </div>

          <div class="grid" id="weekdayLabels">
            <div class="weekday-label">Sun</div><div class="weekday-label">Mon</div><div class="weekday-label">Tue</div>
            <div class="weekday-label">Wed</div><div class="weekday-label">Thu</div><div class="weekday-label">Fri</div>
            <div class="weekday-label">Sat</div>
          </div>

          <div class="grid" id="calendarGrid" role="grid"></div>

          <div class="legend">
            <div style="display:flex;align-items:center;gap:8px"><div class="box period" style="background:var(--pink)"></div> Period</div>
            <div style="display:flex;align-items:center;gap:8px"><div class="box fertile" style="background:var(--mint)"></div> Medium Fertility</div>
            <div style="display:flex;align-items:center;gap:8px"><div class="box high-desire" style="background:var(--purple)"></div> High Fertility & Desire ‚ú®</div>
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button class="btn-ghost" onclick="showStep(2)">Update</button>
            <button class="btn-primary" onclick="showResetModal()">Start Over</button>
          </div>
        </div>

        <p style="margin-top:8px;font-size:13px;color:var(--muted)">
          ‚ö†Ô∏è Predictions are estimates based on the standard rhythm method. High Fertility & Desire marks peak days (around ovulation) when many experience higher desire, arousal & easier intimacy due to hormones ‚Äî individual results vary. Not medical advice.
          <a href="https://github.com/alwin-m/ROS-Cycle-Project" class="github-link" target="_blank" rel="noopener">Contribute on GitHub</a>
        </p>
      </section>
    </main>

    <footer>
      <div style="font-size:12px;color:var(--muted)">
        Open-source ‚Ä¢ MIT License ‚Ä¢ <a href="https://github.com/alwin-m/ROS-Cycle-Project" class="github-link" target="_blank" rel="noopener">GitHub</a> ‚Ä¢
        <a href="https://alwin-m.github.io/Portfolio/" class="portfolio-link" target="_blank" rel="noopener">Portfolio</a>
      </div>
      <div style="display:flex;gap:12px">
        <div class="theme-toggle" onclick="toggleTheme()">Toggle Dark Mode</div>
        <div style="font-size:12px;color:var(--muted)">Made for students ‚Ä¢ Privacy-first</div>
      </div>
    </footer>
  </div>

  <!-- Modals -->
  <div class="modal" id="modal">
    <div class="box">
      <div id="modalText" role="alert"></div>
      <div style="text-align:right;margin-top:16px">
        <button class="btn-primary" onclick="closeModal()">Got it ‚ô°</button>
      </div>
    </div>
  </div>

  <div class="modal" id="resetModal">
    <div class="box">
      <div>Start over? This will clear the current session~</div>
      <div style="text-align:right;margin-top:16px">
        <button class="btn-ghost" onclick="closeModal('resetModal')">Cancel</button>
        <button class="btn-primary" onclick="resetAll()">Yes, start fresh</button>
      </div>
    </div>
  </div>

  <script>
    let state = {
      name: '', dob: null, age: null, last: null, cycle: 28, periodLen: 5, sigma: 2,
      months: [], visibleIndex: 0, pcodChance: null, pcodSymptoms: [], confidence: 0.85
    };

    const el = id => document.getElementById(id);

    function showStep(n) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      if (typeof n === 'string') el('step-' + n).classList.add('active');
      else el('step-' + n).classList.add('active');
      const first = (typeof n === 'string' ? el('step-' + n) : el('step-' + n)).querySelector('input, button');
      if (first) first.focus();
    }

    function showModal(msg) {
      el('modalText').innerHTML = msg.replace(/\n\n/g, '<br><br>');
      el('modal').classList.add('active');
    }

    function closeModal(id = 'modal') {
      el(id).classList.remove('active');
    }

    function showResetModal() {
      el('resetModal').classList.add('active');
    }

    function resetAll() {
      state = {name:'', dob:null, age:null, last:null, cycle:28, periodLen:5, sigma:2, months:[], visibleIndex:0, pcodChance:null, pcodSymptoms:[], confidence:0.85};
      ['name','dob','last','cycle','periodLen','variability'].forEach(id => {
        if (el(id)) el(id).value = id==='cycle'?28:id==='periodLen'?5:id==='variability'?2:'';
      });
      el('pcod-form')?.reset();
      el('calendarGrid').innerHTML = '';
      closeModal('resetModal');
      showStep(1);
    }

    function skipInfo() { state.name = state.dob = state.age = null; showStep(2); }

    function nextToStep2() {
      const name = el('name').value.trim();
      if (!name) return showModal('Please enter your name ‚Äî a short nickname is fine~');
      state.name = name;
      const dob = el('dob').value;
      if (dob) {
        const parsed = new Date(dob);
        const age = calculateAge(parsed);
        if (age < 9 || age > 55) showModal(`Hmm~ Age ${age} seems a bit unusual (typical range 9‚Äì55). Still okay?`);
        state.dob = parsed; state.age = age;
      }
      showStep(2);
    }

    function nextToPCOD() {
      nextToStep2();
      showStep('pcod');
    }

    function checkPCOD() {
      const checked = document.querySelectorAll('#pcod-form input:checked');
      state.pcodSymptoms = Array.from(checked).map(c => c.nextElementSibling.textContent);
      const count = checked.length;
      let chance = 'low', msg = '';
      if (count <= 2) msg = 'Looks pretty low chance of PCOD~';
      else if (count <= 5) { chance = 'medium'; msg = 'Medium chance‚Ä¶ maybe worth chatting with a doctor soon ‚ô°'; }
      else { chance = 'high'; msg = 'Higher chance ‚Äî best to see a doctor for a proper check.<br><br>PCOD can make cycles more unpredictable.'; }
      if (state.pcodSymptoms.length) {
        msg += `<br><br><strong>Symptoms you selected:</strong><ul style="margin:8px 0;padding-left:20px">${state.pcodSymptoms.map(s=>`<li>${s}</li>`).join('')}</ul>`;
      }
      msg += '<br><br>This is <strong>not</strong> a medical diagnosis, okay?';
      state.pcodChance = chance;
      showModal(msg);
    }

    function calculateAge(dob) {
      const today = new Date();
      let age = today.getFullYear() - dob.getFullYear();
      const m = today.getMonth() - dob.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
      return age;
    }

    function getDayDetails(targetDate, lastPeriodDate, cycleLength, periodLength, sigma) {
      const daysSinceLast = Math.floor((targetDate - lastPeriodDate) / (24*60*60*1000));
      if (daysSinceLast < 0) return { type: 'past', phase: 'unknown', pov: 0, fertility: 'low' };
      let dayInCycle = daysSinceLast % cycleLength;
      if (dayInCycle < 0) dayInCycle += cycleLength;
      const ovulationCenter = cycleLength - 14;
      const delta = 1.5;
      const pov = Math.exp( - Math.pow(dayInCycle - ovulationCenter, 2) / (2 * Math.pow(sigma + delta, 2)) );
      let fertility = 'low';
      if (pov > 0.6) fertility = 'high';
      else if (pov > 0.25) fertility = 'medium';
      let phase = 'luteal';
      if (dayInCycle < periodLength) phase = 'menstrual';
      else if (dayInCycle < ovulationCenter) phase = 'follicular';
      else if (Math.abs(dayInCycle - ovulationCenter) < 1) phase = 'ovulation';
      else phase = 'luteal';
      let type = 'normal';
      if (phase === 'menstrual') type = 'period';
      else if (fertility === 'high') type = 'high-desire';
      else if (fertility === 'medium') type = 'fertile';
      return { type, phase, pov, fertility };
    }

    function generateMonthsAhead(count = 12) {
      state.months = [];
      const base = new Date(state.last.getFullYear(), state.last.getMonth(), 1);
      for (let i = 0; i < count; i++) {
        const monthDate = new Date(base.getFullYear(), base.getMonth() + i, 1);
        const daysInMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();
        const monthObj = { month: monthDate.getMonth(), year: monthDate.getFullYear(), days: [] };
        for (let d = 1; d <= daysInMonth; d++) {
          const date = new Date(monthDate.getFullYear(), monthDate.getMonth(), d);
          const details = getDayDetails(date, state.last, state.cycle, state.periodLen, state.sigma);
          monthObj.days.push({ date, ...details });
        }
        state.months.push(monthObj);
      }
    }

    function calculateConfidence() {
      // More gentle curve ‚Äî regular cycles get very high confidence
      const baseConfidence = 1 - (state.sigma / (state.cycle * 0.65));
      const pcodPenalty = state.pcodChance === 'high' ? 0.22 : state.pcodChance === 'medium' ? 0.12 : 0;
      state.confidence = Math.max(0.48, baseConfidence - pcodPenalty);
    }

    function renderMonth(index) {
      if (index < 0 || index >= 12) return;
      const month = state.months[index];
      el('monthTitle').innerText = `${['January','February','March','April','May','June','July','August','September','October','November','December'][month.month]} ${month.year}`;
      el('visible-month').innerText = `${index + 1}/12`;

      const nextPeriod = new Date(state.last);
      nextPeriod.setDate(nextPeriod.getDate() + state.cycle);
      el('greeting').innerHTML = `Hi ${state.name || 'there'}! ‚ô°<br><small>Next period probably around: ${nextPeriod.toLocaleDateString(undefined, {weekday:'long', year:'numeric', month:'long', day:'numeric'})}</small>`;

      let note = '';
      if (state.age) note += `Age: ${state.age}`;
      if (state.pcodChance) note += (note ? ' ‚Ä¢ ' : '') + `PCOD chance: ${state.pcodChance.charAt(0).toUpperCase() + state.pcodChance.slice(1)}`;
      el('age-note').innerText = note;

      const confPercent = Math.round(state.confidence * 100);
      let confColor = confPercent >= 85 ? '#4CAF50' : confPercent >= 70 ? '#9C27B0' : '#FF7043';
      el('confidence-note').innerHTML = `
        <div class="confidence-text">
          Cycle confidence: <strong style="color:${confColor}">${confPercent}%</strong>
          <span class="info-icon" onclick="showConfidenceInfo()" tabindex="0" role="button" aria-label="Learn about cycle confidence">?</span>
          <span style="font-size:11px;">(based on your regularity)</span>
        </div>
      `;
      
      const grid = el('calendarGrid');
      grid.innerHTML = '';
      const firstDay = new Date(month.year, month.month, 1).getDay();
      const totalCells = Math.ceil((firstDay + month.days.length) / 7) * 7;

      for (let i = 0; i < totalCells; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.tabIndex = 0;
        if (i < firstDay || i >= firstDay + month.days.length) {
          cell.className += ' other';
          cell.innerHTML = `<div class="daynum">-</div>`;
        } else {
          const day = month.days[i - firstDay];
          const dateStr = day.date.toLocaleDateString();
          cell.innerHTML = `<div class="daynum">${day.date.getDate()}</div>`;
          let badgeText = '', tooltipText = `Phase: ${day.phase.charAt(0).toUpperCase() + day.phase.slice(1)} ‚Ä¢ Ovulation likelihood: ${Math.round(day.pov * 100)}% ‚Ä¢ Fertility: ${day.fertility.charAt(0).toUpperCase() + day.fertility.slice(1)} ‚Ä¢ ${dateStr}`;
          if (day.type === 'period') {
            badgeText = 'Period';
            cell.innerHTML += `<div class="badge period">${badgeText}</div>`;
          } else if (day.type === 'high-desire') {
            badgeText = 'High Fertility & Desire ‚ú®';
            cell.innerHTML += `<div class="badge high-desire">${badgeText}</div>`;
          } else if (day.type === 'fertile') {
            badgeText = 'Medium Fertility';
            cell.innerHTML += `<div class="badge fertile">${badgeText}</div>`;
          }
          if (tooltipText) {
            const tip = document.createElement('div');
            tip.className = 'tooltip';
            tip.innerText = tooltipText;
            cell.appendChild(tip);
          }
        }
        grid.appendChild(cell);
      }
    }

    function showConfidenceInfo() {
      const conf = Math.round(state.confidence * 100);
      let msg = `
        <strong>Cycle confidence: ${conf}%</strong><br><br>

        This little percentage shows how much we can trust the predictions~ ‚ô°<br><br>

        <strong>Very high (85‚Äì98%)</strong><br>
        ‚Ä¢ Your cycles are super regular<br>
        ‚Ä¢ Very little variation (¬±1‚Äì2 days)<br>
        ‚Ä¢ Usually no PCOD symptoms<br><br>

        <strong>Good (70‚Äì84%)</strong><br>
        ‚Ä¢ Normal natural variation (¬±3‚Äì4 days)<br>
        ‚Ä¢ Sometimes a bit irregular<br>
        ‚Ä¢ Maybe light PCOD influence<br><br>

        <strong>Moderate/Lower (below 70%)</strong><br>
        ‚Ä¢ Bigger variation (¬±5+ days)<br>
        ‚Ä¢ Often irregular or missed periods<br>
        ‚Ä¢ Medium or high PCOD chance<br><br>

        The more consistent your body is‚Ä¶ the more accurate our gentle guesses become~ üå∏
      `;
      showModal(msg);
    }

    function createCalendar() {
      const lastVal = el('last').value;
      const cycle = parseInt(el('cycle').value, 10);
      const periodLen = parseInt(el('periodLen').value, 10);
      const sigma = parseInt(el('variability').value, 10) || 2;

      if (!lastVal || isNaN(cycle) || cycle < 15 || cycle > 45 || 
          isNaN(periodLen) || periodLen < 3 || periodLen > 10 || 
          new Date(lastVal) > new Date()) {
        showModal('Please check your inputs~<br>‚Ä¢ Valid last period date (not future)<br>‚Ä¢ Cycle 15‚Äì45 days<br>‚Ä¢ Period 3‚Äì10 days');
        return;
      }

      state.last = new Date(lastVal);
      state.cycle = cycle;
      state.periodLen = periodLen;
      state.sigma = sigma;

      calculateConfidence();
      generateMonthsAhead(12);
      state.visibleIndex = 0;
      renderMonth(0);
      showStep(3);
    }

    el('prevBtn').onclick = () => { 
      state.visibleIndex = Math.max(0, state.visibleIndex - 1); 
      renderMonth(state.visibleIndex); 
    };

    el('nextBtn').onclick = () => { 
      state.visibleIndex = Math.min(11, state.visibleIndex + 1); 
      renderMonth(state.visibleIndex); 
    };

    function toggleTheme() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    (function init() {
      document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light');
      const today = new Date().toISOString().split('T')[0];
      el('dob').max = today; 
      el('last').max = today;
      el('name').focus();
    })();
    
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        if (el('modal').classList.contains('active')) closeModal();
        if (el('resetModal').classList.contains('active')) closeModal('resetModal');
      }
    });
  </script>
</body>
</html>
